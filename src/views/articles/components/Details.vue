<template>
  <div class="text-white w-full md:w-4/5 lg:w-10/12 xl:w-8/12 mx-auto">
    <div class="py-2 flex items-center">
      <input
        class="w-52 bg-transparent border-b border-gray-400 outline-none"
        type="text"
        v-model="details.title"
      />
      <span
        class="text-sm px-4 py-1 border border-gray-400 rounded-lg cursor-pointer ml-4"
        @click="submit"
        >提交</span
      >
    </div>

    <div id="vditor" class="vditor mt-8"></div>
  </div>
</template>

<script lang="ts" setup>
import Vditor from 'vditor'
import { defineProps, onMounted, ref } from 'vue'
import router from '@/router'
import Alert from '@/components/Alerts'
import type { Details } from './types'
import Articles from '@/api/articles'

const { id } = router.currentRoute.value.params

const props = defineProps({
  isEdit: {
    type: Boolean,
    default: true
  }
})

const details = ref<Details>({})
const contentEditor = ref<any>(null)

onMounted(() => {
  contentEditor.value = new Vditor('vditor', {
    after() {
      if (props.isEdit) {
        new Articles().show(id).then((response) => {
          contentEditor.value.setValue(response.content.markdown)

          details.value = response
        })
      }
    },
    height: 680,
    theme: 'classic',
    toolbarConfig: {
      pin: true
    },
    cache: {
      enable: false
    },
    resize: {
      enable: true
    },
    value: '# Hello leek'
  })
})

const store = (params: any) => {
  new Articles().store(params).then(() => {
    Alert.success('积累值 + 1')

    router.push({ name: 'Backstage.Article' })
  })
}

const update = (params: any) => {
  new Articles().patch(id, params).then(() => {
    Alert.success('修改值 + 1')
  })
}

const submit = () => {
  const params = {
    title: details.value.title,
    markdown: contentEditor.value.getValue(),
    html: ''
  }

  if (props.isEdit) {
    update(params)
  } else {
    store(params)
  }
}
</script>

<style>
@import 'vditor/dist/index.css';
</style>
